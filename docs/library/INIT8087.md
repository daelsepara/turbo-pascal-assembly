# Initialize 8087/80287/80387

Initializes FPU routines in System Library.

```
SYS:02E5 E86404        CALL	074C
```

Test for presence of **FPU** and identify the **[FPU](../DATA.md)** with a call to **[SYS:074C Identify 8087/80287/80387 FPU](TEST8087.md)**.

```
SYS:02E8 0AC0          OR	AL,AL
SYS:02EA 7409          JZ	02F5
```

Check whether an FPU is present.

```
SYS:02EC BE1306        MOV	SI,SYS:0613
SYS:02EF BF9306        MOV	DI,SYS:0693
SYS:02F2 E9E404        JMP	07D9
```

Initialize **FPU** handlers and routines with a jump to **SYS:07D9**.

```
SYS:02F5 1E            PUSH	DS
SYS:02F6 BA0603        MOV	DX,SYS:0306
SYS:02F9 0E            PUSH	CS
SYS:02FA 1F            POP	DS
SYS:02FB B409          MOV	AH,09
SYS:02FD CD21          INT	21
SYS:02FF 1F            POP	DS
SYS:0300 B8FF00        MOV	AX,00FF
SYS:0303 E910FE        JMP	0116
```

Prints the error message (**SYS:306**) and exits with a runtime error **[FF/255 Unknown Error](ERROR-CODES.md)**.

## Data block (string)

```
SYS:0306                    4E 75-6D 65 72 69 63 20 63 6F         Numeric co
SYS:0310  2D 70 72 6F 63 65 73 73-6F 72 20 72 65 71 75 69   -processor requi
SYS:0320  72 65 64 0D 0A 24                                 red..$
```

## Data block (DWORD/TBYTE)

### TBYTE (SYS:0326-032F)
```
SYS:0326  35 C2-68 21 A2 DA 0F C9 FE 3F
```

### TBYTE (SYS:0330-0339)
```
SYS:0330  35 C2 68 21 A2 DA 0F C9-FF 3F 
```

### DWORD (SYS:033A-033D)
```
SYS:033A  00 42 C0 FF
```

### DWORD (SYS:033E-0341)
```
SYS:033E  00 48
SYS:0340  C0 FF
```

### DWORD (SYS:0342-0345)
```
SYS:0342  00 4A C0 FF
```

### DWORD (SYS:0346-0349)
```
SYS:0346  00 00-00 3F
```

### TBYTE (SYS:034A-0353)
```
SYS:034A  85 64 DE F9 33 F3
SYS:0350  04 B5 FF 3F
```

### DWORD (SYS:0354-0357)
```
SYS:0354  00 00 80 7F
```

## Handler for INT 34h-3Dh
```
SYS:0613 55            PUSH	BP
SYS:0614 8BEC          MOV	BP,SP
```

Use **BP** to address items on the stack

### The stack after **SYS:0614**

|Index|Contents                |
|-----|------------------------|
|BP   |Old BP value            |
|BP+02|Return address (OFFSET) |
|BP+04|Return address (SEGMENT)|
|BP+06|Flags Register          |

```
SYS:0616 50            PUSH	AX
SYS:0617 56            PUSH	SI
SYS:0618 1E            PUSH	DS
```

Save these registers

```
SYS:0619 F6460702      TEST	BYTE PTR [BP+07],02
SYS:061D 7401          JZ	0620
SYS:061F FB            STI
```

Check if interrupts are enabled (**IF**, Bit 9 of Flags/Bit 1 of high byte).

```
SYS:0620 C57602        LDS	SI,[BP+02]
```

Load return address into **DS**:**SI**.

```
SYS:0623 8B44FF        MOV	AX,[SI-01]
SYS:0626 2C34          SUB	AL,34
SYS:0628 3C08          CMP	AL,08
SYS:062A 730C          JNB	0638
```

Inspect OpCode and check if it is **3Ch** and above. Note: OpCodes at **DS**:**[SI-02]** would be **CD** **xx** where **xx** (at **DS**:**[SI-01]**) is the byte being inspected.

```
SYS:062C 83EE02        SUB	SI,+02
SYS:062F 8104CEA3      ADD	WORD PTR [SI],A3CE
SYS:0633 897602        MOV	[BP+02],SI
SYS:0636 EB23          JMP	065B
```

Change OpCode to **9B** **Dx**, where **9B** = **WAIT**

```
SYS:0638 7726          JA	0660
SYS:063A F6C420        TEST	AH,20
SYS:063D 752E          JNZ	066D
SYS:063F 83EE02        SUB	SI,+02
SYS:0642 897602        MOV	[BP+02],SI
SYS:0645 C6049B        MOV	BYTE PTR [SI],9B
SYS:0648 46            INC	SI
SYS:0649 8AC4          MOV	AL,AH
SYS:064B 25C007        AND	AX,07C0
SYS:064E D0E8          SHR	AL,1
SYS:0650 D0E8          SHR	AL,1
SYS:0652 D0E8          SHR	AL,1
SYS:0654 3418          XOR	AL,18
SYS:0656 0526D8        ADD	AX,D826
SYS:0659 8904          MOV	[SI],AX
SYS:065B 1F            POP	DS
SYS:065C 5E            POP	SI
SYS:065D 58            POP	AX
SYS:065E 5D            POP	BP
SYS:065F CF            IRET
SYS:0660 3C09          CMP	AL,09
SYS:0662 7709          JA	066D
SYS:0664 83EE02        SUB	SI,+02
SYS:0667 C704909B      MOV	WORD PTR [SI],9B90
SYS:066B EBC6          JMP	0633
SYS:066D EBEC          JMP	065B
```

## Handler for INT 3Eh
```
SYS:0693 FB            STI
SYS:0694 FC            CLD
SYS:0695 50            PUSH	AX
SYS:0696 56            PUSH	SI
SYS:0697 06            PUSH	ES
SYS:0698 55            PUSH	BP
SYS:0699 8BEC          MOV	BP,SP
SYS:069B C47608        LES	SI,[BP+08]
SYS:069E 26            ES:
SYS:069F AD            LODSW
SYS:06A0 897608        MOV	[BP+08],SI
SYS:06A3 3CDC          CMP	AL,DC
SYS:06A5 7209          JB	06B0
SYS:06A7 8BF0          MOV	SI,AX
SYS:06A9 98            CBW
SYS:06AA 96            XCHG	SI,AX
SYS:06AB 2E            CS:
SYS:06AC FF949306      CALL	[SI+0693]
SYS:06B0 5D            POP	BP
SYS:06B1 07            POP	ES
SYS:06B2 5E            POP	SI
SYS:06B3 58            POP	AX
SYS:06B4 CF            IRET
```

```
SYS:07D9 1E            PUSH	DS
SYS:07DA 0E            PUSH	CS
SYS:07DB 1F            POP	DS
SYS:07DC B83425        MOV	AX,2534
SYS:07DF B90A00        MOV	CX,000A
SYS:07E2 8BD6          MOV	DX,SI
SYS:07E4 CD21          INT	21
SYS:07E6 40            INC	AX
SYS:07E7 E2FB          LOOP	07E4
SYS:07E9 8BD7          MOV	DX,DI
SYS:07EB CD21          INT	21
SYS:07ED BA1F08        MOV	DX,SYS:081F
SYS:07F0 B002          MOV	AL,02
SYS:07F2 CD21          INT	21
SYS:07F4 BA1308        MOV	DX,SYS:0813
SYS:07F7 B075          MOV	AL,75
SYS:07F9 CD21          INT	21
SYS:07FB 1F            POP	DS
SYS:07FC A15A02        MOV	AX,[SaveInt02.Segment]
SYS:07FF 2E            CS:
SYS:0800 A38408        MOV	[0884],AX
SYS:0803 A15C02        MOV	AX,[SaveInt02.Offset]
SYS:0806 2E            CS:
SYS:0807 A38608        MOV	[0886],AX
SYS:080A CD37E3        FNINIT
SYS:080D CD352EA2      FLDCW WORD PTR [FPU.ControlWord]
SYS:0812 CB            RETF
```

# Handler for INT 20h (SYS:0813) and INT 75h (SYS:081F)
```
SYS:0813 50            PUSH	AX
SYS:0814 32C0          XOR	AL,AL
SYS:0816 E6F0          OUT	F0,AL
SYS:0818 B020          MOV	AL,20
SYS:081A E6A0          OUT	A0,AL
SYS:081C E620          OUT	20,AL
SYS:081E 58            POP	AX
SYS:081F 50            PUSH	AX
SYS:0820 1E            PUSH	DS
SYS:0821 B84F08        MOV	AX,DATA
SYS:0824 8ED8          MOV	DS,AX
SYS:0826 803E4D0000    CMP	BYTE PTR [Test8087],00
SYS:082B 7507          JNZ	0834
SYS:082D CD3536A802    FNSTENV [FPUEnvironment]
SYS:0832 EB05          JMP	0839
SYS:0834 D936A802      FSTENV	[FPUEnvironment]
SYS:0838 9B            WAIT
SYS:0839 A0A802        MOV	AL,[FPUEnvironment.ControlWord]
SYS:083C F6D0          NOT	AL
SYS:083E 2206AA02      AND	AL,[FPUEnvironment.StatusWord]
SYS:0842 793D          JNS	0881
SYS:0844 FB            STI
SYS:0845 A83D          TEST	AL,3D
SYS:0847 7506          JNZ	084F
SYS:0849 E86300        CALL	08AF
SYS:084C 1F            POP	DS
SYS:084D 58            POP	AX
SYS:084E CF            IRET
SYS:084F CD37E3        FNINIT
SYS:0852 CD352EA202    FLDCW   WORD PTR [FPU.ControlWord]
SYS:0857 E82E00        CALL 0888
SYS:085A 59            POP  CX
SYS:085B 59            POP	CX
SYS:085C 59            POP	CX
SYS:085D 5B            POP	BX
SYS:085E 803E4D0000    CMP	BYTE PTR [Test8087],00
SYS:0863 7419          JZ	087E
SYS:0865 8B16AE02      MOV	DX,[FPUEnvironment.IP]
SYS:0869 B104          MOV	CL,04
SYS:086B D3EA          SHR	DX,CL
SYS:086D 8B1EB002      MOV	BX,[FPUEnvironment.OpCode]
SYS:0871 81E300F0      AND	BX,F000
SYS:0875 03DA          ADD	BX,DX
SYS:0877 8B0EAE02      MOV	CX,[FPUEnvironment.IP]
SYS:087B 83E10F        AND	CX,+0F
SYS:087E E999F8        JMP	011A
SYS:0881 1F            POP	DS
SYS:0882 58            POP	AX
```

```
SYS:0883 EA00000000    JMP	0000:0000
```

```
SYS:0888 A801          TEST	AL,01
SYS:088A 7512          JNZ	089E
SYS:088C B4C8          MOV	AH,C8
SYS:088E A804          TEST	AL,04
SYS:0890 750E          JNZ	08A0
SYS:0892 B4CD          MOV	AH,CD
SYS:0894 A808          TEST	AL,08
SYS:0896 7508          JNZ	08A0
SYS:0898 B4CE          MOV	AH,CE
SYS:089A A810          TEST	AL,10
SYS:089C 7502          JNZ	08A0
SYS:089E B4CF          MOV	AH,CF
SYS:08A0 8AC4          MOV	AL,AH
SYS:08A2 32E4          XOR	AH,AH
SYS:08A4 C3            RET
```

See also: [Test8087 (Variable)](../DATA.md), [Identify 8087/80287/80387 FPU](TEST8087.md), [8087/80287/80387 Control Word](CONTROL8087.md), [8087/80287/80387 Status Word](STATUS8087.md), [8087/80287/80387 x87 FPU Evironment](ENV8087.md), [8087/80287/80387 Temporary data](DATA8087.md), or go [back](../../README.md)