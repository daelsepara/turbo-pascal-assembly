# Initialize 8087/80287/80387

Initializes FPU routines in System Library.

```nasm
SYS02E5: E86404        CALL	074C
```

Test for presence of **FPU** and identify the **[FPU](../DATA.md)** with a call to **[SYS:074C Identify 8087/80287/80387 FPU](TEST8087.md)**.

```nasm
SYS02E8: 0AC0          OR	AL,AL
SYS02EA: 7409          JZ	02F5
```

Check whether an FPU is present then exit when there is none.

```nasm
SYS02EC: BE1306        MOV	SI,0613
SYS02EF: BF9306        MOV	DI,0693
SYS02F2: E9E404        JMP	07D9
```

Initialize **FPU** handlers and routines with a jump to **SYS:07D9**.

```nasm
SYS02F5: 1E            PUSH	DS
SYS02F6: BA0603        MOV	DX,0306
SYS02F9: 0E            PUSH	CS
SYS02FA: 1F            POP	DS
SYS02FB: B409          MOV	AH,09
SYS02FD: CD21          INT	21
SYS02FF: 1F            POP	DS
SYS0300: B8FF00        MOV	AX,00FF
SYS0303: E910FE        JMP	0116
```

Prints the error message (**SYS:306**) and exits with a runtime error **[FFh/255 Unknown Error](ERROR-CODES.md)**.

## Data block (string)

```
SYS0306:                    4E 75-6D 65 72 69 63 20 63 6F         Numeric co
SYS0310:  2D 70 72 6F 63 65 73 73-6F 72 20 72 65 71 75 69   -processor requi
SYS0320:  72 65 64 0D 0A 24                                 red..$
```

## Data block (DWORD/TBYTE)

### TBYTE (SYS:0326-032F)
```
SYS0326:  35 C2-68 21 A2 DA 0F C9 FE 3F
```

### TBYTE (SYS:0330-0339)
```
SYS0330:  35 C2 68 21 A2 DA 0F C9-FF 3F 
```

### DWORD (SYS:033A-033D)
```
SYS033A:  00 42 C0 FF
```

### DWORD (SYS:033E-0341)
```
SYS033E:  00 48
SYS0340:  C0 FF
```

### DWORD (SYS:0342-0345)
```
SYS0342:  00 4A C0 FF
```

### DWORD (SYS:0346-0349)
```
SYS0346:  00 00-00 3F
```

### TBYTE (SYS:034A-0353)
```
SYS034A:  85 64 DE F9 33 F3
SYS0350:  04 B5 FF 3F
```

### DWORD (SYS:0354-0357)
```
SYS0354:  00 00 80 7F
```

## Handler called by **SYS:06AC** on offset = ECh/EEh/F0h (see **SYS:0693 Handler for INT 3Eh** below)

### Called by **SYS:06AC** on offset = ECh (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS0358: B100          MOV	CL,00
SYS035A: EB06          JMP	0362
```

### Called by **SYS:06AC** on offset = EEh (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS035C: B102          MOV	CL,02
SYS035E: EB02          JMP	0362
```

### Called by **SYS:06AC** on offset = F0h (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS0360: B104          MOV	CL,04
```

### Common code used by **SYS:0358**, **SYS:035C**, **SYS:0360**
```nasm
SYS0362: 9B            WAIT
SYS0363: D9E5          FXAM
SYS0365: 55            PUSH	BP
SYS0366: 8BEC          MOV	BP,SP
SYS0368: 8D66FE        LEA	SP,[BP-02]
SYS036B: 9B            WAIT
SYS036C: DD7EFE        FSTSW	[BP-02]
SYS036F: 9B            WAIT
SYS0370: 8A66FF        MOV	AH,[BP-01]
SYS0373: 9E            SAHF
SYS0374: 720F          JB	0385
SYS0376: 752E          JNZ	03A6
SYS0378: 80F902        CMP	CL,02
SYS037B: 7506          JNZ	0383
SYS037D: 9B            WAIT
SYS037E: DDD8          FSTP	ST(0)
SYS0380: 9B            WAIT
SYS0381: D9E8          FLD1
SYS0383: EB1E          JMP	03A3
SYS0385: 740E          JZ	0395
SYS0387: 7B0C          JPO	0395
SYS0389: 9B            WAIT
SYS038A: DDD8          FSTP	ST(0)
SYS038C: 9B            WAIT
SYS038D: 2E            CS:
SYS038E: D9063A03      FLD	DWORD PTR [033A]
SYS0392: 9B            WAIT
SYS0393: D9E4          FTST
SYS0395: EB0C          JMP	03A3
SYS0397: 9B            WAIT
SYS0398: DED9          FCOMPP	ST(1)
SYS039A: 9B            WAIT
SYS039B: 2E            CS:
SYS039C: D9063A03      FLD	DWORD PTR [033A]
SYS03A0: 9B            WAIT
SYS03A1: D9E4          FTST
SYS03A3: E9A700        JMP	044D
SYS03A6: 9B            WAIT
SYS03A7: D9E1          FABS
SYS03A9: 9B            WAIT
SYS03AA: 2E            CS:
SYS03AB: DB2E2603      FLD	TBYTE PTR [0326]
SYS03AF: 9B            WAIT
SYS03B0: D9C9          FXCH	ST(1)
SYS03B2: 9B            WAIT
SYS03B3: D9F8          FPREM
SYS03B5: B502          MOV	CH,02
SYS03B7: 22EC          AND	CH,AH
SYS03B9: D0ED          SHR	CH,1
SYS03BB: 9B            WAIT
SYS03BC: DD7EFE        FSTSW	[BP-02]
SYS03BF: 9B            WAIT
SYS03C0: 8A66FF        MOV	AH,[BP-01]
SYS03C3: 9E            SAHF
SYS03C4: 7AD1          JPE	0397
SYS03C6: B003          MOV	AL,03
SYS03C8: 22C4          AND	AL,AH
SYS03CA: D0E4          SHL	AH,1
SYS03CC: D0E4          SHL	AH,1
SYS03CE: D0D0          RCL	AL,1
SYS03D0: 04FC          ADD	AL,FC
SYS03D2: D0D0          RCL	AL,1
SYS03D4: 80F902        CMP	CL,02
SYS03D7: 7504          JNZ	03DD
SYS03D9: 02C1          ADD	AL,CL
SYS03DB: B500          MOV	CH,00
SYS03DD: 2407          AND	AL,07
SYS03DF: A801          TEST	AL,01
SYS03E1: 7405          JZ	03E8
SYS03E3: 9B            WAIT
SYS03E4: DEE9          FSUBP	ST(1),ST
SYS03E6: EB03          JMP	03EB
SYS03E8: 9B            WAIT
SYS03E9: DDD9          FSTP	ST(1)
SYS03EB: 9B            WAIT
SYS03EC: D9F2          FPTAN
SYS03EE: 80F904        CMP	CL,04
SYS03F1: 7429          JZ	041C
SYS03F3: A803          TEST	AL,03
SYS03F5: 7A03          JPE	03FA
SYS03F7: 9B            WAIT
SYS03F8: D9C9          FXCH	ST(1)
SYS03FA: 9B            WAIT
SYS03FB: D9C1          FLD	ST(1)
SYS03FD: 9B            WAIT
SYS03FE: D8C8          FMUL	ST,ST(0)
SYS0400: 9B            WAIT
SYS0401: D9C9          FXCH	ST(1)
SYS0403: 9B            WAIT
SYS0404: D8C8          FMUL	ST,ST(0)
SYS0406: 9B            WAIT
SYS0407: DEC1          FADDP	ST(1),ST
SYS0409: 9B            WAIT
SYS040A: D9FA          FSQRT
SYS040C: D0E8          SHR	AL,1
SYS040E: D0E8          SHR	AL,1
SYS0410: 32C5          XOR	AL,CH
SYS0412: 7403          JZ	0417
SYS0414: 9B            WAIT
SYS0415: D9E0          FCHS
SYS0417: 9B            WAIT
SYS0418: DEF9          FDIVP	ST(1),ST
SYS041A: EB31          JMP	044D
SYS041C: 8AE0          MOV	AH,AL
SYS041E: D0EC          SHR	AH,1
SYS0420: 80E401        AND	AH,01
SYS0423: 32E5          XOR	AH,CH
SYS0425: 7403          JZ	042A
SYS0427: 9B            WAIT
SYS0428: D9E0          FCHS
SYS042A: A803          TEST	AL,03
SYS042C: 7A1C          JPE	044A
SYS042E: 9B            WAIT
SYS042F: D9C9          FXCH	ST(1)
SYS0431: 9B            WAIT
SYS0432: D9E4          FTST
SYS0434: 9B            WAIT
SYS0435: DD7EFE        FSTSW	[BP-02]
SYS0438: 9B            WAIT
SYS0439: F646FF40      TEST	BYTE PTR [BP-01],40
SYS043D: 740B          JZ	044A
SYS043F: 9B            WAIT
SYS0440: DED9          FCOMPP	ST(1)
SYS0442: 9B            WAIT
SYS0443: 2E            CS:
SYS0444: D9065403      FLD	DWORD PTR [0354]
SYS0448: EB03          JMP	044D
SYS044A: 9B            WAIT
SYS044B: DEF9          FDIVP	ST(1),ST
SYS044D: 8BE5          MOV	SP,BP
SYS044F: 5D            POP	BP
SYS0450: C3            RET
```

## Called by **SYS:06AC** on offset = F2h (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS0451: 9B            WAIT
SYS0452: D9E5          FXAM
SYS0454: 55            PUSH	BP
SYS0455: 8BEC          MOV	BP,SP
SYS0457: 8D66FE        LEA	SP,[BP-02]
SYS045A: 9B            WAIT
SYS045B: DD7EFE        FSTSW	[BP-02]
SYS045E: 9B            WAIT
SYS045F: 8A66FF        MOV	AH,[BP-01]
SYS0462: 9E            SAHF
SYS0463: 91            XCHG	CX,AX
SYS0464: 7204          JB	046A
SYS0466: 751C          JNZ	0484
SYS0468: EB4C          JMP	04B6
SYS046A: 744A          JZ	04B6
SYS046C: 7B48          JPO	04B6
SYS046E: 9B            WAIT
SYS046F: DDD8          FSTP	ST(0)
SYS0471: 9B            WAIT
SYS0472: 2E            CS:
SYS0473: DB2E3003      FLD	TBYTE PTR [0330]
SYS0477: EB35          JMP	04AE
SYS0479: 9B            WAIT
SYS047A: DED9          FCOMPP	ST(1)
SYS047C: 9B            WAIT
SYS047D: 2E            CS:
SYS047E: DB2E2603      FLD	TBYTE PTR [0326]
SYS0482: EB2A          JMP	04AE
SYS0484: 9B            WAIT
SYS0485: D9E1          FABS
SYS0487: 9B            WAIT
SYS0488: D9E8          FLD1
SYS048A: 9B            WAIT
SYS048B: D8D1          FCOM	ST(1)
SYS048D: 9B            WAIT
SYS048E: DD7EFE        FSTSW	[BP-02]
SYS0491: 9B            WAIT
SYS0492: 8A66FF        MOV	AH,[BP-01]
SYS0495: 9E            SAHF
SYS0496: 74E1          JZ	0479
SYS0498: 7303          JNB	049D
SYS049A: 9B            WAIT
SYS049B: D9C9          FXCH	ST(1)
SYS049D: 9B            WAIT
SYS049E: D9F3          FPATAN
SYS04A0: 730C          JNB	04AE
SYS04A2: 9B            WAIT
SYS04A3: 2E            CS:
SYS04A4: DB2E3003      FLD	TBYTE PTR [0330]
SYS04A8: 9B            WAIT
SYS04A9: DEE9          FSUBP	ST(1),ST
SYS04AB: 80F502        XOR	CH,02
SYS04AE: F6C502        TEST	CH,02
SYS04B1: 7403          JZ	04B6
SYS04B3: 9B            WAIT
SYS04B4: D9E0          FCHS
SYS04B6: 8BE5          MOV	SP,BP
SYS04B8: 5D            POP	BP
SYS04B9: C3            RET
```

## Handler called by **SYS:06AC** on offset = F4h/F6h/F8h (see **SYS:0693 Handler for INT 3Eh** below)

### Called by **SYS:06AC** on offset = F6h (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS04BA: 9B            WAIT
SYS04BB: D9E8          FLD1
SYS04BD: EB08          JMP	04C7
```

### Called by **SYS:06AC** on offset = F8h (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS04BF: 9B            WAIT
SYS04C0: D9EC          FLDLG2
SYS04C2: EB03          JMP	04C7
```

### Called by **SYS:06AC** on offset = F4h (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS04C4: 9B            WAIT
SYS04C5: D9ED          FLDLN2
```

### Common code used by **SYS:04BA**, **SYS:04BF**, **SYS:04C4**
```nasm
SYS04C7: 9B            WAIT
SYS04C8: D9C9          FXCH	ST(1)
SYS04CA: 55            PUSH	BP
SYS04CB: 8BEC          MOV	BP,SP
SYS04CD: 9B            WAIT
SYS04CE: D9E5          FXAM
SYS04D0: 8D66F6        LEA	SP,[BP-0A]
SYS04D3: 9B            WAIT
SYS04D4: DD7EF6        FSTSW	[BP-0A]
SYS04D7: 9B            WAIT
SYS04D8: 8A66F7        MOV	AH,[BP-09]
SYS04DB: 9E            SAHF
SYS04DC: 720C          JB	04EA
SYS04DE: 7405          JZ	04E5
SYS04E0: F6C402        TEST	AH,02
SYS04E3: 741A          JZ	04FF
SYS04E5: 9B            WAIT
SYS04E6: DDD8          FSTP	ST(0)
SYS04E8: EB07          JMP	04F1
SYS04EA: 9B            WAIT
SYS04EB: DDD8          FSTP	ST(0)
SYS04ED: 740B          JZ	04FA
SYS04EF: 7B09          JPO	04FA
SYS04F1: 9B            WAIT
SYS04F2: DDD8          FSTP	ST(0)
SYS04F4: 9B            WAIT
SYS04F5: 2E            CS:
SYS04F6: D9063E03      FLD	DWORD PTR [033E]
SYS04FA: 9B            WAIT
SYS04FB: D9E4          FTST
SYS04FD: EB24          JMP	0523
SYS04FF: 9B            WAIT
SYS0500: D9C0          FLD	ST(0)
SYS0502: 9B            WAIT
SYS0503: DB7EF6        FSTP	TBYTE PTR [BP-0A]
SYS0506: 9B            WAIT
SYS0507: 817EFEFF3F    CMP	WORD PTR [BP-02],3FFF
SYS050C: 7512          JNZ	0520
SYS050E: 817EFC0080    CMP	WORD PTR [BP-04],8000
SYS0513: 750B          JNZ	0520
SYS0515: 9B            WAIT
SYS0516: D9E8          FLD1
SYS0518: 9B            WAIT
SYS0519: DEE9          FSUBP	ST(1),ST
SYS051B: 9B            WAIT
SYS051C: D9F9          FYL2XP1
SYS051E: EB03          JMP	0523
SYS0520: 9B            WAIT
SYS0521: D9F1          FYL2X
SYS0523: 8BE5          MOV	SP,BP
SYS0525: 5D            POP	BP
SYS0526: C3            RET
```

## Handler called by **SYS:06AC** on offset = FAh/FCh/FEh (see **SYS:0693 Handler for INT 3Eh** below)

### Called by **SYS:06AC** on offset = FAh (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS0527: 9B            WAIT
SYS0528: D9EA          FLDL2E
SYS052A: B101          MOV	CL,01
SYS052C: EB0B          JMP	0539
```

### Called by **SYS:06AC** on offset = FCh (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS052E: 2BC9          SUB	CX,CX
SYS0530: EB07          JMP	0539
```

### Called by **SYS:06AC** on offset = FEh (see **SYS:0693 Handler for INT 3Eh** below)
```nasm
SYS0532: 9B            WAIT
SYS0533: D9E9          FLDL2T
SYS0535: B101          MOV	CL,01
SYS0537: EB00          JMP	0539
```

### Common code used by **SYS:0527**, **SYS:052E**, **SYS:0532**
```nasm
SYS0539: E303          JCXZ	053E
SYS053B: 9B            WAIT
SYS053C: D9C9          FXCH	ST(1)
SYS053E: 9B            WAIT
SYS053F: D9E5          FXAM
SYS0541: 55            PUSH	BP
SYS0542: 8BEC          MOV	BP,SP
SYS0544: 8D66FA        LEA	SP,[BP-06]
SYS0547: 9B            WAIT
SYS0548: DD7EFA        FSTSW	[BP-06]
SYS054B: E303          JCXZ	0550
SYS054D: 9B            WAIT
SYS054E: D9C9          FXCH	ST(1)
SYS0550: 9B            WAIT
SYS0551: 8A66FB        MOV	AH,[BP-05]
SYS0554: 9E            SAHF
SYS0555: 93            XCHG	BX,AX
SYS0556: 7210          JB	0568
SYS0558: 7526          JNZ	0580
SYS055A: 9B            WAIT
SYS055B: DDD8          FSTP	ST(0)
SYS055D: E303          JCXZ	0562
SYS055F: 9B            WAIT
SYS0560: DDD8          FSTP	ST(0)
SYS0562: 9B            WAIT
SYS0563: D9E8          FLD1
SYS0565: E9A700        JMP	060F
SYS0568: E303          JCXZ	056D
SYS056A: 9B            WAIT
SYS056B: DDD8          FSTP	ST(0)
SYS056D: 740B          JZ	057A
SYS056F: 7B09          JPO	057A
SYS0571: 9B            WAIT
SYS0572: DDD8          FSTP	ST(0)
SYS0574: 9B            WAIT
SYS0575: 2E            CS:
SYS0576: D9064203      FLD	DWORD PTR [0342]
SYS057A: 9B            WAIT
SYS057B: D9E4          FTST
SYS057D: E98F00        JMP	060F
SYS0580: E303          JCXZ	0585
SYS0582: 9B            WAIT
SYS0583: DEC9          FMULP	ST(1),ST
SYS0585: 9B            WAIT
SYS0586: D9E1          FABS
SYS0588: 9B            WAIT
SYS0589: 2E            CS:
SYS058A: D8164603      FCOM	DWORD PTR [0346]
SYS058E: 9B            WAIT
SYS058F: DD7EFA        FSTSW	[BP-06]
SYS0592: 9B            WAIT
SYS0593: F646FB41      TEST	BYTE PTR [BP-05],41
SYS0597: 740B          JZ	05A4
SYS0599: 9B            WAIT
SYS059A: D9F0          F2XM1
SYS059C: 9B            WAIT
SYS059D: D9E8          FLD1
SYS059F: 9B            WAIT
SYS05A0: DEC1          FADDP	ST(1),ST
SYS05A2: EB60          JMP	0604
SYS05A4: 9B            WAIT
SYS05A5: D9E8          FLD1
SYS05A7: 9B            WAIT
SYS05A8: D9C1          FLD	ST(1)
SYS05AA: 9B            WAIT
SYS05AB: D97EFA        FSTCW	[BP-06]
SYS05AE: 9B            WAIT
SYS05AF: D9FD          FSCALE
SYS05B1: 804EFB0F      OR	BYTE PTR [BP-05],0F
SYS05B5: 9B            WAIT
SYS05B6: D96EFA        FLDCW	[BP-06]
SYS05B9: 9B            WAIT
SYS05BA: D9FC          FRNDINT
SYS05BC: 8066FBF3      AND	BYTE PTR [BP-05],F3
SYS05C0: 9B            WAIT
SYS05C1: D96EFA        FLDCW	[BP-06]
SYS05C4: 9B            WAIT
SYS05C5: DB56FC        FIST	DWORD PTR [BP-04]
SYS05C8: 9B            WAIT
SYS05C9: D9C9          FXCH	ST(1)
SYS05CB: 9B            WAIT
SYS05CC: D9E0          FCHS
SYS05CE: 9B            WAIT
SYS05CF: D9C9          FXCH	ST(1)
SYS05D1: 9B            WAIT
SYS05D2: D9FD          FSCALE
SYS05D4: 9B            WAIT
SYS05D5: DDD9          FSTP	ST(1)
SYS05D7: 9B            WAIT
SYS05D8: DEE9          FSUBP	ST(1),ST
SYS05DA: 837EFE00      CMP	WORD PTR [BP-02],+00
SYS05DE: 7F91          JG	0571
SYS05E0: 9B            WAIT
SYS05E1: D9F0          F2XM1
SYS05E3: 9B            WAIT
SYS05E4: D9E8          FLD1
SYS05E6: 9B            WAIT
SYS05E7: DEC1          FADDP	ST(1),ST
SYS05E9: D16EFC        SHR	WORD PTR [BP-04],1
SYS05EC: 7309          JNB	05F7
SYS05EE: 9B            WAIT
SYS05EF: 2E            CS:
SYS05F0: DB2E4A03      FLD	TBYTE PTR [034A]
SYS05F4: 9B            WAIT
SYS05F5: DEC9          FMULP	ST(1),ST
SYS05F7: 9B            WAIT
SYS05F8: DF46FC        FILD	WORD PTR [BP-04]
SYS05FB: 9B            WAIT
SYS05FC: D9C9          FXCH	ST(1)
SYS05FE: 9B            WAIT
SYS05FF: D9FD          FSCALE
SYS0601: 9B            WAIT
SYS0602: DDD9          FSTP	ST(1)
SYS0604: F6C702        TEST	BH,02
SYS0607: 7406          JZ	060F
SYS0609: 9B            WAIT
SYS060A: D9E8          FLD1
SYS060C: 9B            WAIT
SYS060D: DEF1          FDIVRP	ST(1),ST
SYS060F: 8BE5          MOV	SP,BP
SYS0611: 5D            POP	BP
SYS0612: C3            RET
```

## Handler for INT 34h-3Dh
```nasm
SYS0613: 55            PUSH	BP
SYS0614: 8BEC          MOV	BP,SP
```

Use **BP** to address items on the stack

### The stack after **SYS:0614**

|Index|Contents                |
|-----|------------------------|
|BP   |Old BP value            |
|BP+02|Return address (OFFSET) |
|BP+04|Return address (SEGMENT)|
|BP+06|Flags Register          |

```nasm
SYS0616: 50            PUSH	AX
SYS0617: 56            PUSH	SI
SYS0618: 1E            PUSH	DS
```

Save these registers.

```nasm
SYS0619: F6460702      TEST	BYTE PTR [BP+07],02
SYS061D: 7401          JZ	0620
SYS061F: FB            STI
```

Check if interrupts are enabled (**IF**, Bit 9 of Flags/Bit 1 of high byte).

```nasm
SYS0620: C57602        LDS	SI,[BP+02]
```

Load return address into **DS**:**SI**.

### Return address in **DS**:**SI**

|Index|OpCode        |
|-----|--------------|
|SI-02|CDh           |
|SI-01|3xh           |
|SI   |OpCode Byte 00|
|SI+01|OpCode Byte 01|
|...  |...           |

```nasm
SYS0623: 8B44FF        MOV	AX,[SI-01]
SYS0626: 2C34          SUB	AL,34
SYS0628: 3C08          CMP	AL,08
SYS062A: 730C          JNB	0638
```

Inspect OpCode and check if it is **3Ch** and above. Note: OpCodes at **DS**:**[SI-02]** would be **CD** **xx** (see above) where **xx** (at **DS**:**[SI-01]**) is the byte being inspected.

```nasm
SYS062C: 83EE02        SUB	SI,+02
SYS062F: 8104CEA3      ADD	WORD PTR [SI],A3CE
SYS0633: 897602        MOV	[BP+02],SI
SYS0636: EB23          JMP	065B
```

Change OpCode to **9B** **Dx**, where **9B** = **WAIT** and **Dx** is an x87 OPCODE.

```nasm
SYS0638: 7726          JA	0660
```

Check if second byte is above **3Ch** (**OpCode** - **34h** > *08h*).

```nasm
SYS063A: F6C420        TEST	AH,20
SYS063D: 752E          JNZ	066D
```

```nasm
SYS063F: 83EE02        SUB	SI,+02
SYS0642: 897602        MOV	[BP+02],SI
```

Move return address by 2 bytes.

```nasm
SYS0645: C6049B        MOV	BYTE PTR [SI],9B
```

Change OpCode in new **DS**:[**SI**] to **9Bh** = FWAIT.

```nasm
SYS0648: 46            INC	SI
SYS0649: 8AC4          MOV	AL,AH
SYS064B: 25C007        AND	AX,07C0
SYS064E: D0E8          SHR	AL,1
SYS0650: D0E8          SHR	AL,1
SYS0652: D0E8          SHR	AL,1
SYS0654: 3418          XOR	AL,18
SYS0656: 0526D8        ADD	AX,D826
SYS0659: 8904          MOV	[SI],AX
```

```nasm
SYS065B: 1F            POP	DS
SYS065C: 5E            POP	SI
SYS065D: 58            POP	AX
SYS065E: 5D            POP	BP
SYS065F: CF            IRET
```

Restore saved registers and return and pop Flags off the stack.

```nasm
SYS0660: 3C09          CMP	AL,09
SYS0662: 7709          JA	066D
```

Check if OpCode is > **3Dh** then exit. Int **3Eh** is handled separately in **SYS:0693**.

```nasm
SYS0664: 83EE02        SUB	SI,+02
SYS0667: C704909B      MOV	WORD PTR [SI],9B90
SYS066B: EBC6          JMP	0633
```

Insert OpCodes **909Bh** into **DS**:**SI** top replace OpCodes **CD3xh**. OpCode **90h** = WAIT, **9Bh** = FWAIT.

```nasm
SYS066D: EBEC          JMP	065B
```

Jump to exit routine.

## SYS:0693 Handler for INT 3Eh

### Lookup table of offsets (called by **SYS:06AC** below)

| OFFSET |**SI**+0693|[**SI**+0693]| TARGET |
| :----: | :-------: | :---------: | :----: |
|   DC   | SYS:066F  |    B5 06    |SYS:06B5|
|   DE   | SYS:0671  |    C9 06    |SYS:06C9|
|   E0   | SYS:0673  |    DA 06    |SYS:06DA|
|   E2   | SYS:0675  |    DF 06    |SYS:06DF|
|   E4   | SYS:0677  |    16 07    |SYS:0716|
|   E6   | SYS:0679  |    28 07    |SYS:0728|
|   E8   | SYS:067B  |    32 07    |SYS:0732|
|   EA   | SYS:067D  |    37 07    |SYS:0737|
|   EC   | SYS:067F  |    58 03    |SYS:0358|
|   EE   | SYS:0681  |    5C 03    |SYS:035C|
|   F0   | SYS:0683  |    60 03    |SYS:0360|
|   F2   | SYS:0685  |    51 04    |SYS:0451|
|   F4   | SYS:0687  |    C4 04    |SYS:04C4|
|   F6   | SYS:0689  |    BA 04    |SYS:04BA|
|   F8   | SYS:068B  |    BF 04    |SYS:04BF|
|   FA   | SYS:068D  |    27 05    |SYS:0527|
|   FC   | SYS:068F  |    2E 05    |SYS:052E|
|   FE   | SYS:0691  |    32 05    |SYS:0532|

```nasm
SYS0693: FB            STI
SYS0694: FC            CLD
SYS0695: 50            PUSH	AX
SYS0696: 56            PUSH	SI
SYS0697: 06            PUSH	ES
SYS0698: 55            PUSH	BP
```

### The stack after **SYS:0698**

|Index|Contents                |
|-----|------------------------|
|BP   |Old BP value            |
|BP+02|Old ES value            |
|BP+04|Old SI value            |
|BP+06|Old AX value            |
|BP+08|Return address (OFFSET) |
|BP+0A|Return address (SEGMENT)|
|BP+0C|Flags Register          |

```nasm
SYS0699: 8BEC          MOV	BP,SP
SYS069B: C47608        LES	SI,[BP+08]
```

Load return addresss into **ES**:**SI**.

```nasm
SYS069E: 26            ES:
SYS069F: AD            LODSW
SYS06A0: 897608        MOV	[BP+08],SI
```

Load **Bytes** in return address into AX then modify offset part of return address (in stack) to new location (usually, the new location points to a **RETF** OpCode).

```nasm
SYS06A3: 3CDC          CMP	AL,DC
SYS06A5: 7209          JB	06B0
```

Check whether the value in **AL** is an **offset** (>= **DCh**) or an **OpCode**. If **AL** is an OpCode, then return immediately.

```nasm
SYS06A7: 8BF0          MOV	SI,AX
SYS06A9: 98            CBW
SYS06AA: 96            XCHG	SI,AX
SYS06AB: 2E            CS:
SYS06AC: FF949306      CALL	[SI+0693]
```

Since **AL** is an offset, sign extend it into **AX** by setting **AH** = **FFh** using **CBW** (convert byte to word). **SI** then becomes a negative offset, and is used a lookup ([**SI**+0693]) to a **WORD** at **SYS:066F to 0692**. Each of the **WORD** contains an offset address in the **System Library**. 

```nasm
SYS06B0: 5D            POP	BP
SYS06B1: 07            POP	ES
SYS06B2: 5E            POP	SI
SYS06B3: 58            POP	AX
SYS06B4: CF            IRET
```

Restore saved registers and return to the code which triggered **INT 3Eh**.

### Called by **SYS:06AC** on offset = DCh (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS06B5: FECC          DEC	AH
SYS06B7: 7C0E          JL	06C7
SYS06B9: B00A          MOV	AL,0A
SYS06BB: F6E4          MUL	AH
SYS06BD: 96            XCHG	SI,AX
SYS06BE: 9B            WAIT
SYS06BF: DB7A0E        FSTP	TBYTE PTR [BP+SI+0E]
SYS06C2: 83EE0A        SUB	SI,+0A
SYS06C5: 7DF7          JGE	06BE
SYS06C7: 9B            WAIT
SYS06C8: C3            RET
```

### Called by **SYS:06AC** on offset = DEh (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS06C9: 2BF6          SUB	SI,SI
SYS06CB: FECC          DEC	AH
SYS06CD: 7C09          JL	06D8
SYS06CF: 9B            WAIT
SYS06D0: DB6A0E        FLD	TBYTE PTR [BP+SI+0E]
SYS06D3: 83C60A        ADD	SI,+0A
SYS06D6: EBF3          JMP	06CB
SYS06D8: 9B            WAIT
SYS06D9: C3            RET
```

### Called by **SYS:06AC** on offset = E0h (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS06DA: B000          MOV	AL,00
SYS06DC: EB03          JMP	06E1
SYS06DE: 90            NOP
```

### Called by **SYS:06AC** on offset = E2h (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS06DF: B002          MOV  AL,02
```

### Common code used by **SYS:06DA**, **SYS:06DF**
```nasm
SYS06E1: 55            PUSH	BP
SYS06E2: 50            PUSH	AX
SYS06E3: 8BEC          MOV	BP,SP
SYS06E5: 9B            WAIT
SYS06E6: D97E00        FSTCW	[BP+00]
SYS06E9: 9B            WAIT
SYS06EA: 8B7600        MOV	SI,[BP+00]
SYS06ED: 806601FC      AND	BYTE PTR [BP+01],FC
SYS06F1: 084601        OR	[BP+01],AL
SYS06F4: 9B            WAIT
SYS06F5: D96E00        FLDCW	[BP+00]
SYS06F8: 9B            WAIT
SYS06F9: D9EE          FLDZ
SYS06FB: 9B            WAIT
SYS06FC: DCEA          FSUB	ST(2),ST
SYS06FE: 9B            WAIT
SYS06FF: DEC1          FADDP	ST(1),ST
SYS0701: 897600        MOV	[BP+00],SI
SYS0704: 9B            WAIT
SYS0705: D96E00        FLDCW	[BP+00]
SYS0708: 9B            WAIT
SYS0709: DED9          FCOMPP	ST(1)
SYS070B: 9B            WAIT
SYS070C: DD7E00        FSTSW	[BP+00]
SYS070F: 9B            WAIT
SYS0710: 58            POP	AX
SYS0711: 5D            POP	BP
SYS0712: 88660C        MOV	[BP+0C],AH
SYS0715: C3            RET
```

### Called by **SYS:06AC** on offset = E4h (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS0716: 9B            WAIT
SYS0717: DED9          FCOMPP	ST(1)
SYS0719: 8A660D        MOV	AH,[BP+0D]
SYS071C: 9B            WAIT
SYS071D: DD7E0C        FSTSW	[BP+0C]
SYS0720: 9B            WAIT
SYS0721: 8A460D        MOV	AL,[BP+0D]
SYS0724: 89460C        MOV	[BP+0C],AX
SYS0727: C3            RET
```
### Called by **SYS:06AC** on offset = E6h (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS0728: 9B            WAIT
SYS0729: D8D9          FCOMP    ST(1)
SYS072B: EBEC          JMP	0719
SYS072D: 9B            WAIT
SYS072E: D8D1          FCOM	ST(1)
SYS0730: EBE7          JMP	0719
```

### Called by **SYS:06AC** on offset = E8h (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS0732: 9B            WAIT
SYS0733: D9E4          FTST
SYS0735: EBE2          JMP	0719
```

### Called by **SYS:06AC** on offset = EAh (see **SYS:0693 Handler for INT 3Eh** above)
```nasm
SYS0737: 9B            WAIT
SYS0738: D9E5          FXAM
SYS073A: 9B            WAIT
SYS073B: DD7E06        FSTSW	[BP+06]
SYS073E: 9B            WAIT
SYS073F: C3            RET
```

```
SYS0740:  3F 1F 00 00 00 00 00 00-00 80 FF 7F
```

## FPU Interrupt Handlers Initialization

Initializes various handlers for various FPU-related interrupts.

```nasm
SYS07D9: 1E            PUSH	DS
SYS07DA: 0E            PUSH	CS
SYS07DB: 1F            POP	DS
```

Save **DS** then copy **CS** into **DS**.

```nasm
SYS07DC: B83425        MOV	AX,2534
SYS07DF: B90A00        MOV	CX,000A
SYS07E2: 8BD6          MOV	DX,SI
SYS07E4: CD21          INT	21
SYS07E6: 40            INC	AX
SYS07E7: E2FB          LOOP	07E4
```

Set handlers for interrupts **INT 34h-3Dh** to **SYS:0613** using **DOS INT 21h AH=35h set interrupt vector service**.

```nasm
SYS07E9: 8BD7          MOV	DX,DI
SYS07EB: CD21          INT	21
```

Set handler for **INT 3Eh** to **SYS:0693**.

```nasm
SYS07ED: BA1F08        MOV	DX,081F
SYS07F0: B002          MOV	AL,02
SYS07F2: CD21          INT	21
```

Set handler for **INT 02h** (Non-Maskable Interrupt) to **SYS:081F**.

```nasm
SYS07F4: BA1308        MOV	DX,0813
SYS07F7: B075          MOV	AL,75
SYS07F9: CD21          INT	21
```

Set handler for **INT 75h** (FPU Interrupt) to **SYS:081F**.

```nasm
SYS07FB: 1F            POP	DS
SYS07FC: A15A02        MOV	AX,[SaveInt02.Segment]
SYS07FF: 2E            CS:
SYS0800: A38408        MOV	[0884],AX
SYS0803: A15C02        MOV	AX,[SaveInt02.Offset]
SYS0806: 2E            CS:
SYS0807: A38608        MOV	[0886],AX
```nasm

Set **FAR** call in **SYS:0883** to old **INT 02h** handler stored in [**DATA**:[**SaveInt02**]](../DATA.md).

```nasm
SYS080A: CD37E3        FNINIT
SYS080D: CD352EA202    FLDCW WORD PTR [FPU.ControlWord]
SYS0812: CB            RETF
```

Initialize FPU then get the **Control Word**. Store **Control Word** at [FPU.ControlWord] then return.

# Handler for INT 02h (SYS:0813) and INT 75h (SYS:081F)
```nasm
SYS0813: 50            PUSH	AX
```

Save **AX**.

```nasm
SYS0814: 32C0          XOR	AL,AL
SYS0816: E6F0          OUT	F0,AL
```

Clear **FPU** **[busy latch](PORTS.md)**.

```nasm
SYS0818: B020          MOV	AL,20
SYS081A: E6A0          OUT	A0,AL
SYS081C: E620          OUT	20,AL
```

Configure **[8259 Programmable interrupt controller](PORTS.md)**.

```nasm
SYS081E: 58            POP	AX
SYS081F: 50            PUSH	AX
SYS0820: 1E            PUSH	DS
```

Save registers.

```nasm
SYS0821: B84F08        MOV	AX,DATA
SYS0824: 8ED8          MOV	DS,AX
SYS0826: 803E4D0000    CMP	BYTE PTR [Test8087],00
SYS082B: 7507          JNZ	0834
```

Check if an **FPU** is present (**[Test8087](../DATA.md)**). 

```nasm
SYS082D: CD3536A802    FNSTENV [FPUEnvironment]
SYS0832: EB05          JMP	0839
```

Get **[FPU environment](ENV8087.md)**. **FNSTENV** does not check nor handle any pending unmasked floating-point exceptions.

```nasm
SYS0834: D936A802      FSTENV	[FPUEnvironment]
SYS0838: 9B            WAIT
```

```nasm
SYS0839: A0A802        MOV	AL,[FPUEnvironment.ControlWord]
SYS083C: F6D0          NOT	AL
SYS083E: 2206AA02      AND	AL,[FPUEnvironment.StatusWord]
SYS0842: 793D          JNS	0881
```

Check **[ControlWord](CONTROL8087.md)** and **[StatusWord](STATUS8087.md)** exception masks in **[FPUEnvironment](ENV8087.md)**. If none are set, then proceed to original **INT 02h interrupt handler** (**FAR** call in **SYS:0883**).

```nasm
SYS0844: FB            STI
SYS0845: A83D          TEST	AL,3D
SYS0847: 7506          JNZ	084F
SYS0849: E86300        CALL	08AF
SYS084C: 1F            POP	DS
SYS084D: 58            POP	AX
SYS084E: CF            IRET
SYS084F: CD37E3        FNINIT
SYS0852: CD352EA202    FLDCW   WORD PTR [FPU.ControlWord]
SYS0857: E82E00        CALL 0888
SYS085A: 59            POP  CX
SYS085B: 59            POP	CX
SYS085C: 59            POP	CX
SYS085D: 5B            POP	BX
SYS085E: 803E4D0000    CMP	BYTE PTR [Test8087],00
SYS0863: 7419          JZ	087E
SYS0865: 8B16AE02      MOV	DX,[FPUEnvironment.IP]
SYS0869: B104          MOV	CL,04
SYS086B: D3EA          SHR	DX,CL
SYS086D: 8B1EB002      MOV	BX,[FPUEnvironment.OpCode]
SYS0871: 81E300F0      AND	BX,F000
SYS0875: 03DA          ADD	BX,DX
SYS0877: 8B0EAE02      MOV	CX,[FPUEnvironment.IP]
SYS087B: 83E10F        AND	CX,+0F
SYS087E: E999F8        JMP	011A
```

```nasm
SYS0881: 1F            POP	DS
SYS0882: 58            POP	AX
```

Restore modified registers.

```nasm
SYS0883: EA00000000    JMP	0000:0000
```

Jump to original **INT 02h** interrupt handler. Initialliy set to a place holder value (**0000**:**0000**). The **FAR** address is modified in **SYS:0800** and **SYS:0807**.

```nasm
SYS0888: A801          TEST	AL,01
SYS088A: 7512          JNZ	089E
SYS088C: B4C8          MOV	AH,C8
SYS088E: A804          TEST	AL,04
SYS0890: 750E          JNZ	08A0
SYS0892: B4CD          MOV	AH,CD
SYS0894: A808          TEST	AL,08
SYS0896: 7508          JNZ	08A0
SYS0898: B4CE          MOV	AH,CE
SYS089A: A810          TEST	AL,10
SYS089C: 7502          JNZ	08A0
SYS089E: B4CF          MOV	AH,CF
SYS08A0: 8AC4          MOV	AL,AH
SYS08A2: 32E4          XOR	AH,AH
SYS08A4: C3            RET
```

```nasm
SYS08A5: 1E            PUSH	DS
SYS08A6: C51EB202      LDS	BX,[FPUEnvironment.DataPointer]
SYS08AA: 9B            WAIT
```

```nasm
SYS08AB: 90            NOP
SYS08AC: 90            NOP
SYS08AD: 1F            POP	DS
SYS08AE: C3            RET
```

```nasm
SYS08AF: 53            PUSH	BX
SYS08B0: A1B002        MOV	AX,[FPUEnvironment.OpCode]
SYS08B3: 8AD8          MOV	BL,AL
SYS08B5: 80E3C0        AND	BL,C0
SYS08B8: 80FBC0        CMP	BL,C0
SYS08BB: 7404          JZ	08C1
SYS08BD: 2438          AND	AL,38
SYS08BF: 0C07          OR	AL,07
SYS08C1: 86C4          XCHG	AL,AH
SYS08C3: 2407          AND	AL,07
SYS08C5: 0CD8          OR	AL,D8
SYS08C7: 2E            CS:
SYS08C8: A3AB08        MOV	[08AB],AX
SYS08CB: 3DD907        CMP	AX,07D9
SYS08CE: 7450          JZ	0920
SYS08D0: 3DDD07        CMP	AX,07DD
SYS08D3: 744B          JZ	0920
SYS08D5: 3DDB2F        CMP	AX,2FDB
SYS08D8: 7446          JZ	0920
SYS08DA: 3DD817        CMP	AX,17D8
SYS08DD: 7444          JZ	0923
SYS08DF: 3DDC17        CMP	AX,17DC
SYS08E2: 743F          JZ	0923
SYS08E4: 3DD81F        CMP	AX,1FD8
SYS08E7: 743A          JZ	0923
SYS08E9: 3DDC1F        CMP	AX,1FDC
SYS08EC: 7435          JZ	0923
SYS08EE: 3DD837        CMP	AX,37D8
SYS08F1: 740D          JZ	0900
SYS08F3: 3DDC37        CMP	AX,37DC
SYS08F6: 7408          JZ	0900
SYS08F8: 9B            WAIT
SYS08F9: DBE2          FCLEX
SYS08FB: E8A7FF        CALL	08A5
SYS08FE: EB13          JMP	0913
SYS0900: 2E            CS:
SYS0901: 812EAB08FF2F  SUB	WORD PTR [08AB],2FFF
SYS0907: E89BFF        CALL	08A5
SYS090A: E82500        CALL	0932
SYS090D: 9B            WAIT
SYS090E: DBE2          FCLEX
SYS0910: 9B            WAIT
SYS0911: DEF9          FDIVP	ST(1),ST
SYS0913: 9B            WAIT
SYS0914: DD3EA402      FSTSW	[FPU.StatusWord]
SYS0918: 9B            WAIT
SYS0919: A0A402        MOV	AL,[FPU.StatusWord]
SYS091C: 0806AA02      OR	[FPUEnvironment.StatusSword],AL
SYS0920: E80F00        CALL	0932
SYS0923: 9B            WAIT
SYS0924: DBE2          FCLEX
SYS0926: 8026AA02FD    AND	BYTE PTR [FPUEnvironment.StatusSword],FD
SYS092B: 9B            WAIT
SYS092C: D926A802      FLDENV	[FPUEnvironment]
SYS0930: 5B            POP	BX
SYS0931: C3            RET
SYS0932: 9B            WAIT
SYS0933: D9E5          FXAM
SYS0935: 9B            WAIT
SYS0936: DD3EA402      FSTSW   [FPU.StatusWord]
SYS093A: 9B            WAIT
SYS093B: A1A402        MOV	AX,[FPU.StatusWord]
SYS093E: A90045        TEST	AX,4500
SYS0941: 7411          JZ	0954
SYS0943: A90040        TEST	AX,4000
SYS0946: 741B          JZ	0963
SYS0948: A90004        TEST	AX,0400
SYS094B: 7416          JZ	0963
SYS094D: 9B            WAIT
SYS094E: DDD8          FSTP	ST(0)
SYS0950: 9B            WAIT
SYS0951: D9EE          FLDZ
SYS0953: C3            RET
SYS0954: 9B            WAIT
SYS0955: 2E            CS:
SYS0956: DB2E4207      FLD TBYTE PTR [0742]
SYS095A: 9B            WAIT
SYS095B: D9C9          FXCH	ST(1)
SYS095D: 9B            WAIT
SYS095E: D9F8          FPREM
SYS0960: 9B            WAIT
SYS0961: DDD9          FSTP	ST(1)
SYS0963: C3            RET
SYS0964: 0AC0          OR	AL,AL
SYS0966: 7422          JZ	098A
SYS0968: 32C9          XOR	CL,CL
SYS096A: 8AEC          MOV	CH,AH
SYS096C: 8AE6          MOV	AH,DH
SYS096E: 80E480        AND	AH,80
SYS0971: 057E3F        ADD	AX,3F7E
SYS0974: 80CE80        OR	DH,80
SYS0977: 50            PUSH	AX
SYS0978: 52            PUSH	DX
SYS0979: 53            PUSH	BX
SYS097A: 51            PUSH	CX
SYS097B: 33C9          XOR	CX,CX
SYS097D: 51            PUSH	CX
SYS097E: 8BDC          MOV	BX,SP
SYS0980: CD3C5B2F      FLD  SS:TBYTE PTR [BX]
SYS0984: CD3D          FWAIT
SYS0986: 83C40A        ADD	SP,+0A
SYS0989: CB            RETF
SYS098A: CD35EE        FLDZ
SYS098D: CB            RETF
```

See also: [Test8087 (Variable)](../DATA.md), [Identify 8087/80287/80387 FPU](TEST8087.md), [8087/80287/80387 Control Word](CONTROL8087.md), [8087/80287/80387 Status Word](STATUS8087.md), [8087/80287/80387 x87 FPU Evironment](ENV8087.md), [8087/80287/80387 Temporary data](DATA8087.md), or go [back](../../README.md)